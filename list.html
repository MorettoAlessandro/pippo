<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Rapportini - Lista</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Gestione Rapportini - Lista</h1>

        <!-- Pulsante per tornare alla pagina di inserimento rapportini -->
        <div class="form-group">
            <button onclick="window.location.href='index.html'" class="btn-submit">Torna a Inserimento Rapportino</button>
        </div>

        <table id="rapportini-table">
            <thead>
                <tr>
                    <th>Numero Ticket</th>
                    <th>Cliente</th>
                    <th>Data</th>
                    <th>Tempo Impiegato</th>
                    <th>Tipo</th>
                    <th>Numero Commessa</th>
                    <th>Trasferta</th>
                    <th>Descrizione</th>
                    <th>Stato</th>
                    <th>Tecnico</th>
                    <th>Azione</th>
                </tr>
            </thead>
            <tbody id="rapportini-body">
                <!-- I rapportini verranno inseriti qui dinamicamente -->
            </tbody>
        </table>

        <div class="form-group">
            <button id="unisci-tempi" class="btn-submit">Unisci Tempi Selezionati</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const rapportini = JSON.parse(localStorage.getItem('rapportini')) || [];
            const rapportiniBody = document.getElementById('rapportini-body');

            function formatTime(hours) {
                return `${hours.toFixed(2)} ore`;
            }

            function renderTable() {
                rapportiniBody.innerHTML = '';
                rapportini.forEach((r, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${r.numeroTicket}</td>
                        <td>${r.cliente}</td>
                        <td>${r.data}</td>
                        <td>${r.tempoImpegnato}</td>
                        <td>${r.tipoSelezionato}</td>
                        <td>${r.numeroCommessa || ''}</td>
                        <td>${r.trasferta || ''}</td>
                        <td>${r.descrizione}</td>
                        <td>${r.stato}</td>
                        <td>${r.tecnico}</td>
                        <td><button class="btn-delete" data-index="${index}">Cancella</button></td>
                    `;
                    rapportiniBody.appendChild(row);
                });

                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        rapportini.splice(index, 1);
                        localStorage.setItem('rapportini', JSON.stringify(rapportini));
                        renderTable();
                    });
                });
            }

            renderTable();

            document.getElementById('unisci-tempi').addEventListener('click', function() {
                const selectedRows = Array.from(rapportiniBody.querySelectorAll('tr.selected'));

                if (selectedRows.length < 2) {
                    alert('Seleziona almeno due rapportini per unire i tempi.');
                    return;
                }

                let totalHours = 0;
                let descriptions = [];
                let clienti = new Set();
                let tecnici = new Set();

                selectedRows.forEach(row => {
                    const tempoImpegnato = row.cells[3].textContent;
                    const hours = parseFloat(tempoImpegnato) || 0;
                    totalHours += hours;

                    const descrizione = row.cells[7].textContent;
                    descriptions.push(descrizione);

                    const cliente = row.cells[1].textContent;
                    clienti.add(cliente);

                    const tecnico = row.cells[9].textContent;
                    tecnici.add(tecnico);
                });

                const descrizioneUnificata = descriptions.join('; ');
                const clienteFinale = clienti.size === 1 ? Array.from(clienti)[0] : 'Unificato';
                const tecnicoFinale = tecnici.size === 1 ? Array.from(tecnici)[0] : 'Unificato';

                const newRapportino = {
                    tecnico: tecnicoFinale,
                    numeroTicket: `Unito-${Date.now()}`, // Un numero ticket unico
                    cliente: clienteFinale,
                    data: new Date().toISOString().split('T')[0],
                    oraInizio: 'N/A',
                    oraFine: 'N/A',
                    tempoImpegnato: formatTime(totalHours),
                    tipoSelezionato: 'Unificato', // Puoi personalizzare
                    numeroCommessa: '',
                    trasferta: '',
                    descrizione: descrizioneUnificata,
                    stato: 'unito'
                };

                rapportini.push(newRapportino);
                localStorage.setItem('rapportini', JSON.stringify(rapportini));
                renderTable();
            });

            rapportiniBody.addEventListener('click', function(event) {
                if (event.target.closest('tr')) {
                    event.target.closest('tr').classList.toggle('selected');
                }
            });
        });
    </script>
</body>
</html>
